# Playbook: configura servidor web, reemplaza config Apache y crea cron
# Comentarios: cada tarea contiene un comentario breve explicando lo que hace.
- name: Configurar servidor web y cron de chequeo Apache
  hosts: aws
  become: true
  vars:
    # Ruta de origen en la máquina de control: por defecto apunta a la carpeta 'files' del playbook.
    apache_config_src: "/home/ubuntu/Proyecto/SRI/Paginaweb/ConfFinal.conf"
    script_src: "/home/ubuntu/Proyecto/SRI/Paginaweb/chequeoApache.sh"
    remote_script_path: "/opt/scripts/chequeoApache.sh"
    private_index_src: "/home/ubuntu/Proyecto/SRI/Paginaweb/PaginaPrivada/index.html"
    remote_privado_dir: "/var/www/mipagina"
    remote_config_path: "/etc/apache2/sites-available/ConfFinal.conf"
    directorio_claves: "/home/usuario/Proyecto/nube/ansible/proxy/.ssh"
    directorio_repo: "/home/ubuntu"
    repo_github: "https://github.com/AliciaSP2004/Proyecto.git"
    packages:
      - php
      - python3
      - mariadb-client
      - apache2
      - apache2-utils
      - wget

  tasks:
    - name: Instalar paquetes necesarios
      apt:
        name: "{{ packages }}"
        state: present
        update_cache: yes
        cache_valid_time: 3600

    - name: Descargar repositorio de GitHub
      git:
        repo: "{{ repo_github }}"
        dest: "{{ directorio_repo }}/Proyecto"
        version: main
        force: yes
      ignore_errors: yes

    - name: Crear carpeta de scripts remotos
      file:
        path: /opt/scripts
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Crear directorio para la página privada
      file:
        path: "{{ remote_privado_dir }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Copiar `index.html` a /var/www/mipagina
      copy:
        src: "{{ private_index_src }}"
        dest: "{{ remote_privado_dir }}/index.html"
        owner: www-data
        group: www-data
        mode: '0644'
        backup: yes
      notify: Reiniciar Apache

    - name: Copiar configuración de Apache (origen control node)
      copy:
        src: "{{ apache_config_src }}"
        dest: "{{ remote_config_path }}"
        owner: root
        group: root
        mode: '0644'
        backup: yes
      notify: Reiniciar Apache

    - name: Habilitar site Apache (sites-available -> sites-enabled)
      command: a2ensite ConfFinal.conf
      register: a2ensite
      changed_when: a2ensite.rc == 0
      failed_when: a2ensite.rc not in [0,1]
      ignore_errors: yes
      notify: Reiniciar Apache

    - name: Deshabilitar site por defecto 000-default
      command: a2dissite 000-default.conf
      register: a2dissite
      changed_when: a2dissite.rc == 0
      failed_when: a2dissite.rc not in [0,1]
      ignore_errors: yes
      notify: Reiniciar Apache

    - name: Copiar script de chequeo desde control node
      copy:
        src: "{{ script_src }}"
        dest: "{{ remote_script_path }}"
        owner: root
        group: root
        mode: '0755'

    - name: Crear entrada de cron cada 5 minutos para el script
      cron:
        name: "Chequeo Apache cada 5 minutos"
        minute: "*/5"
        user: root
        job: "{{ remote_script_path }} >/dev/null 2>&1"

    - name: Activar módulo auth_basic de Apache
      apache2_module:
        name: auth_basic
        state: present
      notify: Reiniciar Apache

    - name: Crear archivo .htpasswd con usuario1
      htpasswd:
        path: /etc/apache2/.htpasswd
        name: usuario1
        password: usuario@1
    # No incluir owner/group/mode aquí

    - name: Agregar usuario2 al archivo .htpasswd
      htpasswd:
        path: /etc/apache2/.htpasswd
        name: usuario2
        password: usuario@1

    - name: Ajustar permisos del archivo .htpasswd
      file:
        path: /etc/apache2/.htpasswd
        owner: root
        group: www-data
        mode: '0640'

    - name: Crear directorio para WordPress
      file:
        path: /var/www/html/wordpress
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Descargar la última versión de WordPress
      get_url:
        url: https://wordpress.org/latest.tar.gz
        dest: /tmp/wordpress.tar.gz
      register: wordpress_download

    - name: Extraer WordPress en el directorio
      unarchive:
        src: /tmp/wordpress.tar.gz
        dest: /var/www/html/
        owner: www-data
        group: www-data
        remote_src: yes

    - name: Renombrar carpeta wordpress si es necesario
      command: mv /var/www/html/wordpress /var/www/html/wordpress_temp && mv /var/www/html/wordpress_temp /var/www/html/wordpress
      ignore_errors: yes

    - name: Establecer permisos correctos en archivos de WordPress
      file:
        path: /var/www/html/wordpress
        owner: www-data
        group: www-data
        mode: '0755'
        recurse: yes

  handlers:
    - name: Reiniciar Apache
      service:
        name: apache2
        state: restarted